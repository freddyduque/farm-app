<?php
include_once '../../includes/session_val.php';
include_once '../../includes/local_functions.php';
session_start();

if(isset($_POST['signup_email'])) {
  $data = check_user();
  exit(json_encode($data));
}

if(isset($_SESSION['UserID'])){
  redirect_home();
  exit;
}

if(isset($_POST['btn-login'])){
  $retval = get_user();
  if($retval==0)
    redirect_home();
  else
    $login_error = true;
}

if(isset($_POST['btn-signup'])){
  $retval = set_user();
}

/*
  elseif($retval==1)
    $error = "Password incorrecta";
  elseif($retval==2)
    $error = "Usuario no existe";
*/
?>
  <!DOCTYPE html>
  <html lang="en">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Vakuno.com</title>
    <meta name="author" content="Freddy Duque">
    <meta name="description" content="Sistema de Gestion Ganadera Online - Vakuno">
    <meta name="keywords" content="">
    <meta name="application-name" content="Vakuno">

    <!-- Bootstrap -->
    <link href="css/bootstrap-theme.min.css" rel="stylesheet">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/bootstrap-social.css" rel="stylesheet">
    <!-- Plugins -->
    <link href="css/font-awesome.min.css" rel="stylesheet">
    <!-- Customs -->
    <link href="css/vakuno-main.css" rel="stylesheet">
    <link href="css/vakuno-global.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body class="login-page">
    <?php include_once("../../includes/vakuno/analyticstracking.php") ?>
      <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container-fluid">
          <div class="navbar-header">
            <a class="navbar-brand custom-navbar-brand" href="http://www.vakuno.com">
              <p class="text-center custom-brand">
                <img src="img/vk_logo35x35.svg" alt="Vakuno 35x35 logo" />
                <span class="custom-brand-name">Vakuno<subname>.com</subname></span>
              </p>
            </a>
          </div>
        </div>
      </nav>
      <div class="container-fluid">
        <div class="row">
          <div class="col-sm-5">
            <div class="container login-container">
              <div class="login-panel panel panel-default">
                <p class="text-center custom-brand">
                  <span class="custom-brand-name">Vakuno<subname>.com</subname></span>
                </p>
                <ul class="nav nav-tabs" role="tablist">
                  <li role="presentation" class="custom-tab active"><a href="#login" aria-controls="login" role="tab" data-toggle="tab">Acceso</a></li>
                  <li role="presentation" class="custom-tab"><a href="#signup" aria-controls="signup" role="tab" data-toggle="tab">Registro</a></li>
                </ul>
                <div class="tab-content">
                  <div role="tabpanel" class="tab-pane fade in active" id="login">
                    <div class="panel-body">
                      <form method="POST" action="index.html" class="form-horizontal mt0" id="login-form" role="form">
                        <div class="form-group">
                          <div class="col-md-12">
                            <?php if($login_error)echo error_alert("Ups! Algo salió mal.","Verifica que tu Correo y/o Contraseña sean correctos");?>
                              <label for="input_login_email">Correo</label>
                          </div>
                          <div class="col-lg-12">
                            <div class="input-group">
                              <input type="email" class="form-control email" name="input_login_email" id="input_login_email" aria-required="true" aria-invalid="true" placeholder="tucorreo@vakuno.com" required>
                              <span class="input-group-addon custom-glyphicon">
                                <span class="glyphicon glyphicon-envelope"></span>
                              </span>
                            </div>
                            <div class="alert alert-danger alert-dismissible custom-alert" hidden="hidden" role="alert" belongs-to="input_login_email">
                              <button type="button" class="close" data-hide="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                              <span></span>
                            </div>
                          </div>
                        </div>
                        <div class="form-group">
                          <div class="col-md-12">
                            <label for="input_login_password">Contraseña</label>
                          </div>
                          <div class="col-lg-12">
                            <div class="input-group">
                              <input aria-invalid="false" aria-required="true" name="input_login_password" id="input_login_password" class="form-control valid" type="password" placeholder="tucontraseña1234" required>
                              <span class="input-group-addon">
                                <span class="glyphicon glyphicon-lock"></span>
                              </span>
                            </div>
                          </div>
                        </div>
                        <div class="form-group">
                          <!-- <div class="col-md-12">
                            <div class="checkbox">
                              <input type="checkbox" id="checkbox-custom01">
                              <label for="checkbox-custom01">Remember me?</label>
                            </div>
                          </div>-->
                          <div class="col-md-12">
                            <button type="submit" class="btn btn-primary btn-block vk-btn-validation" name="btn-login" id="btn-login">Iniciar Sesión <span class="glyphicon glyphicon-user"></span></button>
                          </div>
                        </div>
                      </form>
                      <span class="help-block text-center"><a data-toggle="collapse" data-target="#panel-footer-01" style="text-decoration: none;cursor: pointer">¿Olvidó su Contraseña?</a></span>
                    </div>
                    <div class="collapse gray-lighter-bg" id="panel-footer-01">
                      <div class="panel-footer">
                        <p class="text-center" style="padding-top: 5px">Introduzca su correo a continución para recuperar su contraseña.</p>
                        <form role="form" class="form-horizontal mt0" action="index.html" id="retrieve-form">
                          <div class="form-group">
                            <div class="col-lg-12">
                              <div class="input-group">
                                <input type="email" aria-invalid="false" aria-required="true" name="email_retrieve_pass" id="email_retrieve_pass" class="form-control valid email" placeholder="tucorreo@vakuno.com" required>
                                <span class="input-group-addon custom-glyphicon">
                                  <span class="glyphicon glyphicon-envelope"></span>
                                </span>
                              </div>
                              <div class="alert alert-danger alert-dismissible custom-alert" hidden="hidden" role="alert" belongs-to="email_retrieve_pass">
                                <button type="button" class="close" data-hide="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <span></span>
                              </div>
                            </div>
                          </div>
                          <div class="form-group" style="margin-bottom: 0px;padding-bottom:15px">
                            <div class="col-md-12">
                              <button type="submit" class="btn btn-primary btn-block" name="btn-retrieve" id="btn-retrieve">Recuperar</button>
                            </div>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>
                  <div role="tabpanel" class="tab-pane fade" id="signup">
                    <div class="panel-body">
                      <form method="POST" action="index.html" class="form-horizontal mt0" id="signup-form" role="form">
                        <div class="form-group">
                          <div class="col-md-12">
                            <label for="input_signup_email">Correo</label>
                          </div>
                          <div class="col-lg-12">
                            <div class="input-group">
                              <input type="email" class="form-control email" name="input_signup_email" id="input_signup_email" aria-required="true" aria-invalid="true" placeholder="tucorreo@vakuno.com" required>
                              <span class="input-group-addon custom-glyphicon">
                                <span class="glyphicon glyphicon-envelope"></span>
                              </span>
                            </div>
                            <div class="alert alert-danger alert-dismissible custom-alert" hidden="hidden" role="alert" belongs-to="input_signup_email">
                              <button type="button" class="close" data-hide="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                              <span></span>
                            </div>
                          </div>
                        </div>
                        <div class="form-group">
                          <div class="col-md-12">
                            <label for="input_signup_pass01">Contraseña</label>
                          </div>
                          <div class="col-lg-12">
                            <div class="input-group">
                              <input aria-invalid="false" aria-required="true" name="input_signup_pass01" id="input_signup_pass01" class="form-control valid" type="password" placeholder="tucontraseña1234" linked-element="input_signup_pass02" required>
                              <span class="input-group-addon custom-glyphicon">
                                <span class="glyphicon glyphicon-lock"></span>
                              </span>
                            </div>
                            <div class="alert alert-danger alert-dismissible custom-alert" hidden="hidden" role="alert" belongs-to="input_signup_pass01">
                              <button type="button" class="close" data-hide="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                              <span></span>
                            </div>
                          </div>
                        </div>
                        <div class="form-group">
                          <div class="col-md-12">
                            <label for="input_signup_pass02">Verifique su contraseña</label>
                          </div>
                          <div class="col-lg-12">
                            <div class="input-group">
                              <input aria-invalid="false" aria-required="true" name="input_signup_pass02" id="input_signup_pass02" class="form-control valid" type="password" placeholder="tucontraseña1234" linked-element="input_signup_pass01" required disabled>
                              <span class="input-group-addon custom-glyphicon">
                                <span class="glyphicon glyphicon-lock"></span>
                              </span>
                            </div>
                            <div class="alert alert-danger alert-dismissible custom-alert" hidden="hidden" role="alert" belongs-to="input_signup_pass02">
                              <button type="button" class="close" data-hide="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                              <span></span>
                            </div>
                          </div>
                        </div>
                        <div class="col-sm-12 line-separator"></div>
                        <div class="form-group">
                          <div class="col-md-12">
                            <label for="input_firstname" id="firstname_label">Nombre</label>
                          </div>
                          <div class="col-lg-12">
                            <input type="text" class="form-control input_val" name="input_firstname" id="input_firstname" aria-required="true" aria-invalid="true" placeholder="José" linked-label="firstname_label" val-lvl="1" required>
                            <div class="alert alert-danger alert-dismissible custom-alert" hidden="hidden" role="alert" belongs-to="input_firstname">
                              <button type="button" class="close" data-hide="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                              <span></span>
                            </div>
                          </div>
                        </div>
                        <div class="form-group">
                          <div class="col-md-12">
                            <label for="input_lastname" id="lastname_label">Apellido</label>
                          </div>
                          <div class="col-lg-12">
                            <input type="text" class="form-control input_val" name="input_lastname" id="input_lastname" aria-required="true" aria-invalid="true" placeholder="García" linked-label="lastname_label" val-lvl="1" required>
                            <div class="alert alert-danger alert-dismissible custom-alert" hidden="hidden" role="alert" belongs-to="input_lastname">
                              <button type="button" class="close" data-hide="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                              <span></span>
                            </div>
                          </div>
                        </div>
                        <!--<div class="form-group">
                          <div class="col-md-12">
                            <label for="inputPhone">Teléfono</label>
                          </div>
                          <div class="col-lg-12">
                            <div class="input-group">
                              <input type="text" class="form-control" name="inputPhone" id="inputPhone" aria-required="true" aria-invalid="true" placeholder="+58 276 123 4567" required>
                              <span class="input-group-addon">
                                <span class="glyphicon glyphicon-phone-alt"></span>
                              </span>
                            </div>
                          </div>
                        </div>-->
                        <div class="form-group">
                          <div class="col-md-12">
                            <button type="submit" class="btn btn-primary btn-block vk-btn-validation" name="btn-signup" id="btn-signup">Registrar <span class="glyphicon glyphicon-user"></span></button>
                          </div>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-sm-7"></div>
        </div>
      </div>
      <footer class="footer">
        <div class="container">
          <p class="text-muted">
            <?php echo $retval?>
          </p>
          <a class="btn btn-social-icon btn-sm btn-facebook" href="https://www.facebook.com/vakunoweb">
            <span class="fa fa-facebook"></span>
          </a>
          <a class="btn btn-social-icon btn-sm btn-instagram" href="https://www.instagram.com/vakunoweb/">
            <span class="fa fa-instagram"></span>
          </a>
          <a class="btn btn-social-icon btn-sm btn-twitter" href="https://twitter.com/vakunoweb">
            <span class="fa fa-twitter"></span>
          </a>
        </div>
      </footer>
      <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
      <script src="js/jquery.min.js"></script>
      <!-- Include all compiled plugins (below), or include individual files as needed -->
      <script src="js/bootstrap.min.js"></script>
      <script>
        //src="js/vk_functions.js">
        function AlertManagement(condition, Ele, AlertEle, icon = false, message01 = "", message02 = "") {
          //condition = true (show), condition = false (hide); icon = true (input has icon)/false (input has no icon)
          //alert("condition:" + condition + " Element:" + $(Ele).val() + " icon:" + icon + " Mensaje 01:" + message01 + " Mensaje 02:" + message02);
          if (condition) {
            $(AlertEle).show();
            if (icon) {
              $(Ele).siblings(".custom-glyphicon").css("background-color", "#ebccd1");
              $(Ele).siblings(".custom-glyphicon").css("color", "#a94442");
            }
            $(AlertEle).children("span").html("<strong>" + message01 + "</strong><br>" + message02);
            return true;
          } else {
            $(AlertEle).hide();
            if (icon) {
              $(Ele).siblings(".custom-glyphicon").css("background-color", "#bbddbd");
              $(Ele).siblings(".custom-glyphicon").css("color", "#3c763d");
            }
            return false;
          }
        }

        function ValidateEmail(Ele, option) {
          var mailformat = /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,4})+$/,
            AlertEle = $(Ele).parent().siblings(".alert");
          if (mailformat.test($(Ele).val())) {
            if (option) {
              $.post("index.html", {
                signup_email: $(Ele).val()
              }, "json").done(function (data) {
                if (data == "true")
                  return AlertManagement(false, Ele, AlertEle, true);
                else
                  return AlertManagement(true, Ele, AlertEle, true, "Ups! Algo salió mal.", "Parece que este Correo ya se encuentra en uso, prueba con otro.");
              });
            } else
              return AlertManagement(false, Ele, AlertEle, true);
          } else
            return AlertManagement(true, Ele, AlertEle, true, "Correo Invalido!", "Verifica nuevamente tu correo.");
        }

        function ValidateInput(Ele, lvl = "") {
          //alert("Element: " + $(Ele).attr('id') + " Nivel de Validación: " + lvl);
          var flag = true,
            AlertEle = $(Ele).siblings(".alert"),
            FieldTitle = $("#" + $(Ele).attr("linked-label")).text();
          if (lvl.indexOf("1") != -1) { //validates letters only
            var just_letters = /^[a-zA-Z]+$/;
            if (!just_letters.test($(Ele).val()))
              flag = false;
          }
          if (flag)
            return AlertManagement(false, Ele, AlertEle);
          else
            return AlertManagement(true, Ele, AlertEle, false, "Error en el Campo \"" + FieldTitle + "\"", "Verifica que el campo no contenga números ni caracteres especiales");
        }

        function ValidatePass(Ele) {
          var flag = true,
            message = "Esta debe contener:",
            AlertEle = $(Ele).parent().siblings(".alert");
          if ($(Ele).val().length < 8) {
            message = message + "<br> * Al menos 8 caracteres";
            flag = false;
          }
          re = /[0-9]/;
          if (!re.test($(Ele).val())) {
            message = message + "<br> * Al menos un número";
            flag = false;
          }
          re = /[a-z]/;
          if (!re.test($(Ele).val())) {
            message = message + "<br> * Al menos una letra minúscula";
            flag = false;
          }
          re = /[A-Z]/;
          if (!re.test($(Ele).val())) {
            message = message + "<br> * Al menos una letra mayúscula";
            flag = false;
          }
          if (!flag) {
            $("#" + $(Ele).attr("linked-element")).attr('disabled', 'disabled');
            $("#" + $(Ele).attr("linked-element")).parent().siblings().hide();
            ResetEle("#" + $(Ele).attr("linked-element"));
            return AlertManagement(true, Ele, AlertEle, true, "Verifica tú Contraseña!", message);
          } else {
            $("#" + $(Ele).attr("linked-element")).removeAttr('disabled');
            return AlertManagement(false, Ele, AlertEle, true);
          }
        }

        function ValidateConfirmPass(Ele) {
          var AlertEle = $(Ele).parent().siblings(".alert");
          //alert("Pass01: " + $(Ele).val() + " Pass02: " + $("#input_signup_pass01").val());
          if ($(Ele).val() != $("#" + $(Ele).attr("linked-element")).val())
            return AlertManagement(true, Ele, AlertEle, true, "Error en Confirmación!", "Verifique que las contraseñas coincidan.");
          else
            return AlertManagement(false, Ele, AlertEle, true);
        }

        function ResetEle(Ele) {
          $(Ele).siblings(".custom-glyphicon").css("background-color", "");
          $(Ele).siblings(".custom-glyphicon").css("color", "");
          $(Ele).val("");
        }

        function isEmpty(Ele) {
          if ($(Ele).val() == "")
            return true;
          else
            return false;
        }

        function CheckForm() {

        }

        $(function () {
          $("#input_login_email").focus();
          $("[data-hide]").on("click", function () {
            $(this).parent().hide();
            ResetEle($("#" + $(this).parent().attr("belongs-to")));
          });
          $(".email").blur(function (event) {
            if (!isEmpty(this))
              if (/signup/i.test($(this).attr("id")))
                ValidateEmail(this, true);
              else
                ValidateEmail(this, false);
            return true;
          });
          $(".input_val").blur(function (event) {
            if (!isEmpty(this))
              ValidateInput(this, $(this).attr("val-lvl"));
            return true;
          });
          $("#input_signup_pass01").bind("keyup blur", function (event) {
            if (!isEmpty(this))
              ValidatePass(this);
            return true;
          });
          $("#input_signup_pass02").blur(function (event) {
            ValidateConfirmPass(this);
            return true;
          });
          $("#input_signup_pass01,#input_signup_pass02").on("contextmenu", function () {
            return false;
          });






          $(".vk-btn-validation").click(function (event) {
            var flag = true,
              val_flag = true;
            $("#" + $(this).closest('form').attr("id") + " input").each(function () {
              if (!isEmpty(this)) {
                var Ele = $(this).attr("id");
                if ($(this).attr("type") == "email")
                  if (/signup/i.test(Ele))
                    flag = ValidateEmail(this, true);
                  else
                    flag = ValidateEmail(this, false);
                else if ($(this).attr("type") == "password")
                  if (/signup/i.test(Ele))
                    if (/pass01/i.test(Ele))
                      flag = ValidatePass(this);
                    else
                      flag = ValidateConfirmPass(this);
                else if ($(this).attr("type") == "text")
                  flag = ValidateInput(this, $(this).attr("val-lvl"));
                $(this).css({
                  'border-left': '',
                  'border-color': ''
                });
              } else {
                $(this).css({
                  'border-left': '6px solid #ccc',
                  'border-color': '#a94442'
                });
              }
              if (!flag) val_flag = false;
            });
            return val_flag;
          });
        });
      </script>
  </body>

  </html>
