<?php
include("../../includes/mysql.php");
session_start();
$db = new mysql();

if(isset($_SESSION['UserSession'])){
  header("Location: prompt-main/index.html");
  $mysqli->close();
  exit;
}

if(isset($_POST['btn-login'])){
  $email = $db -> quote($_POST['input_login_email']);
  $upass = $db -> quote($_POST['input_login_password']);
  $hashedPassword = password_hash($upass, PASSWORD_DEFAULT);
  $rows = $db -> select("SELECT * FROM VK_USER WHERE EMAIL=".$email.";");

  foreach ($rows as $value){
    extract($value);
    if(password_verify($upass, $PASSWORD))
      $retval1 = "User Verified";
    else
      $retval1 = "User NOT Verified";
  }

/*





if(strcmp( $upass, $row['PASSWORD']) == 0  ){          //if(password_verify($upass, $row['password'])){
    $_SESSION['UserSession'] = $row['IDUSER'];
    $_SESSION['UserName'] = $row['FIRST_NAME'];
    $_SESSION['UserLastName'] = $row['LAST_NAME'];
    $_SESSION['UserEmail'] = $row['EMAIL'];
    header("Location: prompt-main/index.html");
  }else
    $msg = "<div class='alert alert-danger alert-dismissible' role='alert'>
      <button type='button' class='close' data-dismiss='alert' aria-label='Close'><span aria-hidden='true'>&times;</span></button>
      <strong>Email</strong> or <strong>Password</strong> doesn't exists!
    </div>";
  $mysqli->close();
  }*/
}
?>
  <!DOCTYPE html>
  <html lang="en">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Vakuno.com</title>
    <meta name="author" content="Freddy Duque">
    <meta name="description" content="Sistema de Gestion Ganadera Online - Vakuno">
    <meta name="keywords" content="">
    <meta name="application-name" content="Vakuno">

    <!-- Bootstrap -->
    <link href="css/bootstrap-theme.min.css" rel="stylesheet">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/bootstrap-social.css" rel="stylesheet">
    <!-- Plugins -->
    <link href="css/font-awesome.min.css" rel="stylesheet">
    <!-- Customs -->
    <link href="css/vakuno-main.css" rel="stylesheet">
    <link href="css/vakuno-global.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body class="login-page">
    <?php include_once("../../includes/vakuno/analyticstracking.php") ?>
      <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container-fluid">
          <div class="navbar-header">
            <?php if(isset($email) && isset($upass))echo $email.' '.$hashedPassword.' '.$retval1.' '.$retval2.' '.$retval3;?>
              <a class="navbar-brand custom-navbar-brand" href="">
                <p class="text-center custom-brand">
                  <img src="img/vk_logo40x40.svg" alt="Vakuno 40x40 logo" />
                  <span class="custom-brand-name">Vakuno<subname>.com</subname></span>
                </p>
              </a>
          </div>
        </div>
      </nav>
      <div class="container-fluid">
        <div class="row">
          <div class="col-sm-5">
            <div class="container login-container">
              <div class="login-panel panel panel-default">
                <p class="text-center custom-brand">
                  <span class="custom-brand-name">Vakuno<subname>.com</subname></span>
                </p>
                <ul class="nav nav-tabs" role="tablist">
                  <li role="presentation" class="custom-tab active"><a href="#login" aria-controls="login" role="tab" data-toggle="tab">Acceso</a></li>
                  <li role="presentation" class="custom-tab"><a href="#signup" aria-controls="signup" role="tab" data-toggle="tab">Registro</a></li>
                </ul>
                <div class="tab-content">
                  <div role="tabpanel" class="tab-pane fade in active" id="login">
                    <div class="panel-body">
                      <form method="POST" action="index.html" class="form-horizontal mt0" id="login-form" role="form">
                        <div class="form-group">
                          <div class="col-md-12">
                            <label for="input_login_email">Correo</label>
                          </div>
                          <div class="col-lg-12">
                            <div class="input-group">
                              <input type="email" class="form-control email" name="input_login_email" id="input_login_email" aria-required="true" aria-invalid="true" placeholder="tucorreo@vakuno.com" required>
                              <span class="input-group-addon custom-glyphicon">
                                <span class="glyphicon glyphicon-envelope"></span>
                              </span>
                            </div>
                            <div class="alert alert-danger alert-dismissible custom-alert" hidden="hidden" role="alert" belongs-to="input_login_email">
                              <button type="button" class="close" data-hide="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                              <span></span>
                            </div>
                          </div>
                        </div>
                        <div class="form-group">
                          <div class="col-md-12">
                            <label for="input_login_password">Contraseña</label>
                          </div>
                          <div class="col-lg-12">
                            <div class="input-group">
                              <input aria-invalid="false" aria-required="true" name="input_login_password" id="input_login_password" class="form-control valid" type="password" placeholder="tucontraseña1234" required>
                              <span class="input-group-addon">
                                <span class="glyphicon glyphicon-lock"></span>
                              </span>
                            </div>
                          </div>
                        </div>
                        <div class="form-group">
                          <!-- <div class="col-md-12">
                            <div class="checkbox">
                              <input type="checkbox" id="checkbox-custom01">
                              <label for="checkbox-custom01">Remember me?</label>
                            </div>
                          </div>-->
                          <div class="col-md-12">
                            <button type="submit" class="btn btn-primary btn-block" name="btn-login" id="btn-login">Iniciar Sesión <span class="glyphicon glyphicon-user"></span></button>
                          </div>
                        </div>
                      </form>
                      <span class="help-block text-center"><a data-toggle="collapse" data-target="#panel-footer-01" style="text-decoration: none;cursor: pointer">¿Olvidó su Contraseña?</a></span>
                    </div>
                    <div class="collapse gray-lighter-bg" id="panel-footer-01">
                      <div class="panel-footer">
                        <p class="text-center" style="padding-top: 5px">Introduzca su correo a continución para recuperar su contraseña.</p>
                        <form role="form" class="form-horizontal mt0" action="index.html" id="retrieve-form">
                          <div class="form-group">
                            <div class="col-lg-12">
                              <div class="input-group">
                                <input type="email" aria-invalid="false" aria-required="true" name="email_retrieve_pass" id="email_retrieve_pass" class="form-control valid email" placeholder="tucorreo@vakuno.com" required>
                                <span class="input-group-addon custom-glyphicon">
                                  <span class="glyphicon glyphicon-envelope"></span>
                                </span>
                              </div>
                              <div class="alert alert-danger alert-dismissible custom-alert" hidden="hidden" role="alert" belongs-to="email_retrieve_pass">
                                <button type="button" class="close" data-hide="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <span></span>
                              </div>
                            </div>
                          </div>
                          <div class="form-group" style="margin-bottom: 0px;padding-bottom:15px">
                            <div class="col-md-12">
                              <button type="submit" class="btn btn-primary btn-block" name="btn-retrieve" id="btn-retrieve">Recuperar</button>
                            </div>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>
                  <div role="tabpanel" class="tab-pane fade" id="signup">
                    <div class="panel-body">
                      <form method="POST" action="index.html" class="form-horizontal mt0" id="signup-form" role="form">
                        <div class="form-group">
                          <div class="col-md-12">
                            <label for="signup_email">Correo</label>
                          </div>
                          <div class="col-lg-12">
                            <div class="input-group">
                              <input type="text" class="form-control email" name="signup_email" id="signup_email" aria-required="true" aria-invalid="true" placeholder="tucorreo@vakuno.com" required>
                              <span class="input-group-addon custom-glyphicon">
                                <span class="glyphicon glyphicon-envelope"></span>
                              </span>
                            </div>
                            <div class="alert alert-danger alert-dismissible custom-alert" hidden="hidden" role="alert" belongs-to="signup_email">
                              <button type="button" class="close" data-hide="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                              <span></span>
                            </div>
                          </div>
                        </div>
                        <div class="form-group">
                          <div class="col-md-12">
                            <label for="input_signup_pass01">Contraseña</label>
                          </div>
                          <div class="col-lg-12">
                            <div class="input-group">
                              <input aria-invalid="false" aria-required="true" name="input_signup_pass01" id="input_signup_pass01" class="form-control valid" type="password" placeholder="tucontraseña1234" required>
                              <span class="input-group-addon custom-glyphicon">
                                <span class="glyphicon glyphicon-lock"></span>
                              </span>
                            </div>
                            <div class="alert alert-danger alert-dismissible custom-alert" hidden="hidden" role="alert" belongs-to="input_signup_pass01">
                              <button type="button" class="close" data-hide="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                              <span></span>
                            </div>
                          </div>
                        </div>
                        <div class="form-group">
                          <div class="col-md-12">
                            <label for="input_signup_pass02">Verifique su contraseña</label>
                          </div>
                          <div class="col-lg-12">
                            <div class="input-group">
                              <input aria-invalid="false" aria-required="true" name="input_signup_pass02" id="input_signup_pass02" class="form-control valid" type="password" placeholder="tucontraseña1234" required disabled>
                              <span class="input-group-addon custom-glyphicon">
                                <span class="glyphicon glyphicon-lock"></span>
                              </span>
                            </div>
                            <div class="alert alert-danger alert-dismissible custom-alert" hidden="hidden" role="alert" belongs-to="input_signup_pass02">
                              <button type="button" class="close" data-hide="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                              <span></span>
                            </div>
                          </div>
                        </div>
                        <div class="col-sm-12 line-separator"></div>
                        <div class="form-group">
                          <div class="col-md-12">
                            <label for="inputFirstName">Nombre</label>
                          </div>
                          <div class="col-lg-12">
                            <input type="text" class="form-control" name="inputFirstName" id="inputFirstName" aria-required="true" aria-invalid="true" placeholder="José" required>
                          </div>
                        </div>
                        <div class="form-group">
                          <div class="col-md-12">
                            <label for="inputLastName">Apellido</label>
                          </div>
                          <div class="col-lg-12">
                            <input type="text" class="form-control" name="inputLastName" id="inputLastName" aria-required="true" aria-invalid="true" placeholder="García" required>
                          </div>
                        </div>
                        <!--<div class="form-group">
                          <div class="col-md-12">
                            <label for="inputPhone">Teléfono</label>
                          </div>
                          <div class="col-lg-12">
                            <div class="input-group">
                              <input type="text" class="form-control" name="inputPhone" id="inputPhone" aria-required="true" aria-invalid="true" placeholder="+58 276 123 4567" required>
                              <span class="input-group-addon">
                                <span class="glyphicon glyphicon-phone-alt"></span>
                              </span>
                            </div>
                          </div>
                        </div>-->
                        <div class="form-group">
                          <div class="col-md-12">
                            <button type="submit" class="btn btn-primary btn-block" name="btn-login" id="btn-login">Registrar <span class="glyphicon glyphicon-user"></span></button>
                          </div>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-sm-7"></div>
        </div>
      </div>
      <footer class="footer">
        <div class="container">
          <p class="text-muted"></p>
          <a class="btn btn-social-icon btn-sm btn-facebook" href="https://www.facebook.com/vakunoweb">
            <span class="fa fa-facebook"></span>
          </a>
          <a class="btn btn-social-icon btn-sm btn-instagram" href="https://www.instagram.com/vakunoweb/">
            <span class="fa fa-instagram"></span>
          </a>
          <a class="btn btn-social-icon btn-sm btn-twitter" href="https://twitter.com/vakunoweb">
            <span class="fa fa-twitter"></span>
          </a>
        </div>
      </footer>
      <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
      <script src="js/jquery.min.js"></script>
      <!-- Include all compiled plugins (below), or include individual files as needed -->
      <script src="js/bootstrap.min.js"></script>
      <script src="js/patternizer.js"></script>
      <script>
        $(function () {
          $("#input_login_email").focus();
          $("[data-hide]").on("click", function () {
            $(this).parent().hide();
            ResetEle($("#" + $(this).parent().attr("belongs-to")));
          });
          $(".email").focusout(function (event) {
            ValidateEmail(this);
          });
          $("#input_signup_pass01").keyup(function (event) {
            ValidatePass(this);
          });
          $("#input_signup_pass02").focusout(function (event) {
            ValidateConfirmPass(this);
          });
        });

        function AlertManagement(type, Ele, icon = false, message01 = "", message02 = "") {
          //type = true (show), type = false (hide); icon = true (input has icon)/false (input has no icon)
          //alert("Type:" + type + " Element:" + $(Ele).val() + " icon:" + icon + " Mensaje 01:" + message01 + " Mensaje 02:" + message02);
          if (type) {
            $(Ele).parent().siblings().show();
            if (icon) {
              $(Ele).siblings(".custom-glyphicon").css("background-color", "#ebccd1");
              $(Ele).siblings(".custom-glyphicon").css("color", "#a94442");
            }
            $(Ele).parent().siblings().children("span").html("<strong>" + message01 + "</strong><br>" + message02);
          } else {
            $(Ele).parent().siblings().hide();
            if (icon) {
              $(Ele).siblings(".custom-glyphicon").css("background-color", "#bbddbd");
              $(Ele).siblings(".custom-glyphicon").css("color", "#3c763d");
            }
          }
        }

        function ValidateEmail(Ele) {
          if ($(Ele).val() != "") {
            var mailformat = /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,4})+$/;
            if (mailformat.test($(Ele).val())) {
              AlertManagement(false, Ele, true);
              return true;
            } else {
              AlertManagement(true, Ele, true, "Correo Invalido!", "Verifique nuevamente su correo.");
              return false;
            }
          }
        }

        function ValidatePass(Ele) {
          var flag = true,
            message = "Verifique que la contraseña contenga:";
          if ($(Ele).val().length < 8) {
            message = message + "<br> * Al menos 8 caracteres";
            flag = false;
          }
          re = /[0-9]/;
          if (!re.test($(Ele).val())) {
            message = message + "<br> * Al menos un número";
            flag = false;
          }
          re = /[a-z]/;
          if (!re.test($(Ele).val())) {
            message = message + "<br> * Al menos una letra minúscula";
            flag = false;
          }
          re = /[A-Z]/;
          if (!re.test($(Ele).val())) {
            message = message + "<br> * Al menos una letra mayúscula";
            flag = false;
          }
          if (!flag) {
            $("#input_signup_pass02").attr('disabled', 'disabled');
            $("#input_signup_pass02").parent().siblings().hide();
            ResetEle("#input_signup_pass02");
            AlertManagement(true, Ele, true, "Contraseña Invalida!", message);
          } else {
            $("#input_signup_pass02").removeAttr('disabled');
            AlertManagement(false, Ele, true);
          }
        }

        function ResetEle(Ele) {
          $(Ele).siblings(".custom-glyphicon").css("background-color", "");
          $(Ele).siblings(".custom-glyphicon").css("color", "");
          $(Ele).val("");
        }

        function ValidateConfirmPass(Ele) {
          //alert("Pass01: " + $(Ele).val() + " Pass02: " + $("#input_signup_pass01").val());
          if ($(Ele).val() != ($("#input_signup_pass01")).val())
            AlertManagement(true, Ele, true, "Error en Confirmación!", "Verifique que las contraseñas coincidan.");
          else
            AlertManagement(false, Ele, true);
        }
      </script>
  </body>

  </html>
