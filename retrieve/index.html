<?php
include_once '../../../includes/vakuno/session_val.php';
include_once '../../../includes/vakuno/mailer.php';
include_once '../../../includes/vakuno/local_functions.php';

if(isset($_GET['e']) && isset($_GET['t'])){
  $ret_val=check_user_token($_GET['e'],$_GET['t'],2);
  switch ($ret_val[1]) {
    case 1:
      break;
    case 2:
      $custom_class="panel-warning";
      $custom_title="El enlace no es correcto";
      $custom_title_class="custom-panel-warning";
      $custom_body="<strong>Disculpa</strong>, estamos teniendo algunas dificultades para validar el enlace que estás usando. Ve a tu correo y copia el enlace, luego pegalo en tu explorador y verifica si la falla persiste. Si aún no logras reiniciar tu contraseña, ponte en contacto con nuestro personal de soporte enviandonos un correo a <a href='mailto:support@vakuno.com'>support@vakuno.com</a>.";
      break;
    case 3:
      $custom_class="panel-warning";
      $custom_title="El enlace ha expirado";
      $custom_title_class="custom-panel-warning";
      $custom_body="<strong>Disculpa</strong>, el enlace de reinicio de contraseña que estás intentando usar ha expirado. Solicita nuevamente el reinicio de tu contraseña desde la pagina inicial. Si aún no logras reiniciar tu contraseña, ponte en contacto con nuestro personal de soporte enviandonos un correo a <a href='mailto:support@vakuno.com'>support@vakuno.com</a>.";
      break;
    case 4:
      $custom_class="panel-warning";
      $custom_title="¡Ups, algo salió mal!";
      $custom_title_class="custom-panel-warning";
      $custom_body="<strong>Disculpa</strong>, estamos teniendo algunas dificultades para verificar tu correo, por favor intentalo nuevamente. Si aún no logras reiniciar tu contraseña, ponte en contacto con nuestro personal de soporte enviandonos un correo a <a href='mailto:support@vakuno.com'>support@vakuno.com</a>.";
      break;
    default:
      $custom_class="panel-danger";
      $custom_title="¡Ups, algo salió mal!";
      $custom_title_class="custom-panel-daner";
      $custom_body="<strong>Disculpa</strong>, estamos teniendo algunas dificultades para reiniciar la contraseña de este correo, por favor intentalo nuevamente. Si aún no logras reiniciar tu contraseña, ponte en contacto con nuestro personal de soporte enviandonos un correo a <a href='mailto:support@vakuno.com'>support@vakuno.com</a>.";
  }
}else{
  redirect_main();
  exit;
}
?>
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
  <title>Vakuno</title>
  <meta name="author" content="Freddy Duque">
  <meta name="description" content="Sistema de Gestión Ganadera Online - Vakuno">
  <meta name="keywords" content="">
  <meta name="application-name" content="Vakuno">

  <!-- Bootstrap -->
  <link href="../css/bootstrap-theme.min.css" rel="stylesheet">
  <link href="../css/bootstrap.min.css" rel="stylesheet">
  <link href="../css/bootstrap-social.css" rel="stylesheet">
  <!-- Plugins -->
  <link href="../css/font-awesome.min.css" rel="stylesheet">
  <!-- Customs -->
  <link href="../css/vakuno-main.css" rel="stylesheet">
  <link href="../css/vakuno-global.css" rel="stylesheet">

  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>

<body>
  <?php include_once("../../../includes/vakuno/analyticstracking.php") ?>
  <div class="modal fade" id="confirmation-modal" tabindex="-1" role="dialog" aria-labelledby="gridSystemModalLabel">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header custom-modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="gridSystemModalLabel"></h4>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-xs-12">
              <p class="text-center" id="gridSystemModalBody"></p>
            </div>
          </div>
        </div>
        <div class="modal-footer custom-modal-footer">
          <button type="button" class="btn btn-primary btn-block" data-dismiss="modal">Excelente! <span class="glyphicon glyphicon-thumbs-up"></span></button>
        </div>
      </div>
    </div>
  </div>
  <nav class="navbar navbar-default navbar-fixed-top">
    <div class="container-fluid">
      <div class="navbar-header">
        <a class="navbar-brand custom-navbar-brand" href="http://www.vakuno.com">
          <div class="text-center custom-brand">
            <img src="../img/new/vk_logo35x35.svg" alt="Vakuno 35x35 logo" />
            <span class="custom-brand-name">Vakuno</span>
          </div>
        </a>
      </div>
    </div>
  </nav>
  <div class="container-fluid">
    <div class="row">
      <?php if($ret_val[0]){?>
      <div id="ret_correct" class="col-lg-12">
        <div class="container login-container">
          <div class="login-panel panel panel-default">
            <p class="text-center custom-brand">
              <span class="custom-brand-name">Vakuno</span>
            </p>
            <div class="panel-body">
              <form method="POST" action="?e=<?php echo $_GET['e']?>&t=<?php echo $_GET['t']?>" class="form-horizontal mt0" id="retrieve-form" role="form">
                <div class="col-sm-12 line-separator"></div>
                <div class="form-group">
                  <div class="col-lg-12">
                    <label for="input_retrieve_email">Correo</label>
                  </div>
                  <div class="col-lg-12">
                    <div class="input-group">
                      <input type="email" class="form-control email" name="input_retrieve_email" id="input_retrieve_email" readonly value="<?php echo $_GET['e']?>">
                      <span class="input-group-addon">
                        <span class="glyphicon glyphicon-envelope"></span>
                      </span>
                    </div>
                  </div>
                </div>
                <div class="col-sm-12 line-separator"></div>
                <div class="form-group">
                  <div class="col-md-12">
                    <label for="input_ret_signup_pass01">Nueva contraseña</label>
                  </div>
                  <div class="col-lg-12">
                    <div class="input-group">
                      <input aria-invalid="false" aria-required="true" name="input_ret_signup_pass01" id="input_ret_signup_pass01" class="form-control valid" type="password" placeholder="tucontraseña1234" linked-element="input_ret_signup_pass02" required>
                      <span class="input-group-addon custom-glyphicon">
                  <span class="glyphicon glyphicon-lock"></span>
                      </span>
                    </div>
                    <div class="alert alert-danger alert-dismissible custom-alert" hidden="hidden" role="alert" belongs-to="input_ret_signup_pass01">
                      <button type="button" class="close" data-hide="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                      <span></span>
                    </div>
                  </div>
                </div>
                <div class="form-group">
                  <div class="col-md-12">
                    <label for="input_ret_signup_pass02">Verifique su contraseña</label>
                  </div>
                  <div class="col-lg-12">
                    <div class="input-group">
                      <input aria-invalid="false" aria-required="true" name="input_ret_signup_pass02" id="input_ret_signup_pass02" class="form-control valid" type="password" placeholder="tucontraseña1234" linked-element="input_ret_signup_pass01" required>
                      <span class="input-group-addon custom-glyphicon">
                  <span class="glyphicon glyphicon-lock"></span>
                      </span>
                    </div>
                    <div class="alert alert-danger alert-dismissible custom-alert" hidden="hidden" role="alert" belongs-to="input_ret_signup_pass02">
                      <button type="button" class="close" data-hide="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                      <span></span>
                    </div>
                  </div>
                </div>
                <div class="form-group">
                  <div class="col-md-12">
                    <input type="hidden" name="email" value="<?php echo $_GET['e']?>">
                    <input type="hidden" name="token" value="<?php echo $_GET['t']?>">
                    <button type="submit" class="btn btn-primary btn-block vk-btn-validation" name="btn-change-pass" id="btn-change-pass">Modificar<!--<span class="glyphicon glyphicon-user"></span>--></button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      <?php }else{ ?>
      <div id="ret_error" class="col-xl-5">
        <div class="container custom-message">
          <div class="panel <?php echo $custom_class?>">
            <div class="panel-heading text-center">
              <div class="custom-brand <?php echo $custom_title_class?>">
                <img src="../img/new/vk_logo35x35.svg" alt="Vakuno 35x35 logo">
                <span class="custom-brand-name">Vakuno</span>
              </div>
              <div class="custom-title">
                <p class="panel-title">
                  <?php echo $custom_title;?>
                </p>
              </div>
            </div>
            <div class="panel-body">
              <?php echo $custom_body;?>
              <br>
              <div class="text-center">Serás redireccionado a la pagína inicial despues de <strong><delay></delay></strong></div>
            </div>
          </div>
        </div>
      </div>
      <?php }?>
    </div>
  </div>
  <footer class="footer">
    <div class="container">
      <p class="text-muted"></p>
      <a class="btn btn-social-icon btn-sm btn-facebook" href="https://www.facebook.com/vakunoweb">
        <span class="fa fa-facebook"></span>
      </a>
      <a class="btn btn-social-icon btn-sm btn-instagram" href="https://www.instagram.com/vakunoweb/">
        <span class="fa fa-instagram"></span>
      </a>
      <a class="btn btn-social-icon btn-sm btn-twitter" href="https://twitter.com/vakunoweb">
        <span class="fa fa-twitter"></span>
      </a>
    </div>
  </footer>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="../js/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="../js/bootstrap.min.js"></script>
  <script src="../js/vk_functions.js"></script>
  <script>
  $(function () {
    $("#input_ret_signup_pass01").focus();

    var delay = 1000,
      URL = "http://localhost/vakuno.com/",
      //URL = "http://www.vakuno.com",
      secs = 10;

    if ($("#ret_error").length) {
      $("delay").html(secs + " segundos");
      setInterval(function () {
        secs--;
        if (secs == 1)
          $("delay").html(secs + " segundo");
        else
          $("delay").html(secs + " segundos");
        0 == secs && (window.location = URL);
      }, delay);
    }

    $('#confirmation-modal').on('hidden.bs.modal', function () {
      window.location = URL;
    })
  });
  </script>
  <?php
  if(isset($_POST['btn-change-pass'])){
    $ret_change_pass = change_password($_POST['email'],$_POST['input_ret_signup_pass01'],$_POST['input_ret_signup_pass02']);
    if($ret_change_pass[0]){
      echo "<script> call_modal($('#confirmation-modal'),'¡Hemos cambiado tu Contraseña!','Ya puedes iniciar sesion en <strong><a href=".'http://www.vakuno.com'.">Vakuno</a></strong>. Presiona el botón, el sistema te redireccionará automaticamnete a la pagina de inicio de sesión.');</script>";
    }else{
      echo "<script> call_modal($('#confirmation-modal'),'¡Ups, algo salió mal!','<strong>Disculpa</strong>, estamos teniendo algunas dificultades para reiniciar tu contraseña, por favor intentalo nuevamente. Si aún no logras reiniciar tu contraseña, ponte en contacto con nuestro personal de soporte enviandonos un correo a <a href=".'mailto:support@vakuno.com'.">support@vakuno.com</a>.');</script>";
    }
  }
  ?>
</body>

</html>
